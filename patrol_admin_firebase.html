<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Patroli — Admin Monitor</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<style>
body{font-family:Inter,system-ui,Roboto,Arial;margin:0;background:#f6f8fb;color:#111}
.header{background:#06204a;color:#fff;padding:12px 14px;display:flex;align-items:center;justify-content:space-between}
.container{max-width:1200px;margin:12px auto;padding:12px;display:grid;grid-template-columns:320px 1fr;gap:12px}
.card{background:#fff;border-radius:8px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.officer-row{padding:8px;border-radius:8px;border:1px solid #eef2ff;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;gap:8px}
.small{font-size:12px;color:#666}
.photo-thumb{width:64px;height:48px;object-fit:cover;border-radius:4px;border:1px solid #eee}
</style>
</head>
<body>
<div class="header"><div style="font-weight:800">Patroli Admin — Realtime Monitor</div><div>Admin</div></div>

<div class="container">
  <div class="card" id="leftPanel">
    <div style="font-weight:700;margin-bottom:8px">Daftar Petugas Aktif</div>
    <div id="list"></div>
  </div>

  <div class="card" id="rightPanel">
    <div id="detailHeader" style="font-weight:700;margin-bottom:8px">Pilih petugas untuk detail</div>
    <div id="detail"></div>
  </div>
</div>

<script>
/* ========== CONFIG ========== */
/* GANTI DENGAN FIREBASE CONFIG LO (sama dengan client) */

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBlW0bCNzY9X-6u8jF5Bqt0TT9egcYC-VU",
  authDomain: "patroilgptracking.firebaseapp.com",
  databaseURL: "https://patroilgptracking-default-rtdb.firebaseio.com",
  projectId: "patroilgptracking",
  storageBucket: "patroilgptracking.firebasestorage.app",
  messagingSenderId: "653208547594",
  appId: "1:653208547594:web:7c187fc4a4fba5b815caf3"
};

/* ============================ */

firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();

const refs = { list: document.getElementById('list'), detail: document.getElementById('detail'), detailHeader: document.getElementById('detailHeader') };
let officers = {};

const liveRef = db.ref('/live');
liveRef.on('value', snap=>{
  const data = snap.val() || {};
  refs.list.innerHTML = '';
  officers = data;
  const sortedKeys = Object.keys(data).sort((a,b)=> (data[b].updatedAt||0) - (data[a].updatedAt||0));
  sortedKeys.forEach(k=>{
    const x = data[k];
    const div = document.createElement('div'); div.className='officer-row';
    const left = document.createElement('div');
    left.innerHTML = `<div style="font-weight:700">${x.officerName||k}</div><div class="small">Shift: ${x.shift||'-'} • Last: ${new Date(x.updatedAt||Date.now()).toLocaleTimeString()}</div>`;
    const right = document.createElement('div'); right.style.textAlign='right';
    if(x.lastPhoto && x.lastPhoto.url){
      right.innerHTML = `<img src="${x.lastPhoto.url}" class="photo-thumb"><div class="small">${x.lastPhoto.meta? x.lastPhoto.meta.name : ''}</div>`;
    }else if(x.signatureUrl){
      right.innerHTML = `<img src="${x.signatureUrl}" class="photo-thumb"><div class="small">signature</div>`;
    } else {
      right.innerHTML = `<div class="small">no media</div>`;
    }
    div.appendChild(left); div.appendChild(right);
    div.onclick = ()=> showDetail(k);
    refs.list.appendChild(div);
  });
});

function showDetail(id){
  const d = officers[id] || {};
  refs.detailHeader.textContent = (d.officerName||id) + ' — Detail';
  refs.detail.innerHTML = '';
  const info = document.createElement('div');
  info.innerHTML = `<div><strong>Shift</strong>: ${d.shift||'-'}</div>
                    <div><strong>Last GPS</strong>: ${d.lastGps? (d.lastGps.lat.toFixed(6)+', '+d.lastGps.lon.toFixed(6)+' @ '+ new Date(d.lastGps.ts).toLocaleString()) : '-'}</div>
                    <div><strong>Updated</strong>: ${new Date(d.updatedAt||Date.now()).toLocaleString()}</div>`;
  refs.detail.appendChild(info);

  const photosWrap = document.createElement('div'); photosWrap.style.marginTop='12px';
  photosWrap.innerHTML = '<div style="font-weight:700">Photos</div>';
  refs.detail.appendChild(photosWrap);

  const photosRef = db.ref('/live/'+id+'/photos');
  photosRef.once('value').then(s=>{
    const v = s.val() || {};
    const keys = Object.keys(v).reverse();
    if(keys.length===0) photosWrap.innerHTML += '<div class="small">Belum ada foto</div>';
    keys.forEach(k=>{
      const p = v[k];
      const el = document.createElement('div'); el.style.marginTop='8px';
      el.innerHTML = `<div style="display:flex;gap:8px;align-items:center">
        <img src="${p.url}" style="width:160px;height:110px;object-fit:cover;border:1px solid #eee">
        <div>
          <div><strong>${p.meta?.name||k}</strong></div>
          <div class="small">Uploaded: ${new Date(p.uploadedAt).toLocaleString()}</div>
          <div class="small">GPS: ${p.gps ? (p.gps.lat.toFixed(6)+', '+p.gps.lon.toFixed(6)) : '-'}</div>
          <div style="margin-top:6px"><a href="${p.url}" target="_blank">Open full</a></div>
        </div>
      </div>`;
      photosWrap.appendChild(el);
    });
  });

  const areasWrap = document.createElement('div'); areasWrap.style.marginTop='12px';
  areasWrap.innerHTML = '<div style="font-weight:700">Areas</div>';
  refs.detail.appendChild(areasWrap);
  const areasRef = db.ref('/live/'+id+'/areas');
  areasRef.once('value').then(s=>{
    const v = s.val()||{};
    if(Object.keys(v).length===0) areasWrap.innerHTML += '<div class="small">Belum ada area</div>';
    Object.values(v).forEach(a=>{
      const el = document.createElement('div'); el.className='small'; el.style.marginTop='6px';
      el.textContent = `${a.name} — ${new Date(a.createdAt).toLocaleString()}`;
      areasWrap.appendChild(el);
    });
  });

  const sigWrap = document.createElement('div'); sigWrap.style.marginTop='12px';
  sigWrap.innerHTML = '<div style="font-weight:700">Signature</div>';
  refs.detail.appendChild(sigWrap);
  const sigRef = db.ref('/live/'+id+'/signature');
  sigRef.once('value').then(s=>{
    const v = s.val();
    if(!v || !v.url) sigWrap.innerHTML += '<div class="small">Tidak ada tanda tangan</div>';
    else sigWrap.innerHTML += `<div style="margin-top:6px"><img src="${v.url}" style="width:240px;height:80px;object-fit:contain;border:1px solid #eee"></div><div class="small">Saved: ${new Date(v.ts).toLocaleString()}</div>`;
  });

  const mapWrap = document.createElement('div'); mapWrap.style.marginTop='12px';
  if(d.lastGps) {
    const lat = d.lastGps.lat, lon = d.lastGps.lon;
    mapWrap.innerHTML = `<div style="font-weight:700">Map</div><div style="margin-top:6px"><a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}" target="_blank">Open in Google Maps</a></div>`;
  } else {
    mapWrap.innerHTML = `<div class="small">No GPS yet</div>`;
  }
  refs.detail.appendChild(mapWrap);
}
</script>
</body>
</html>
