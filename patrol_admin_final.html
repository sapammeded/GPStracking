<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Patroli — Admin Monitor (Full)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>
<style>
body{font-family:Inter,system-ui,Roboto,Arial;margin:0;background:#f6f8fb;color:#111}
.header{background:#06204a;color:#fff;padding:12px 14px;display:flex;justify-content:space-between;align-items:center}
.container{max-width:1200px;margin:12px auto;padding:12px;display:grid;grid-template-columns:360px 1fr;gap:12px}
.card{background:#fff;border-radius:8px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.small{font-size:13px;color:#666}
#map{height:520px;border-radius:8px}
.photo-thumb{width:100px;height:70px;object-fit:cover;border:1px solid #eee}
</style>
</head>
<body>
<div class="header"><div style="font-weight:800">Patroli Admin — Monitor</div><div>Admin</div></div>
<div class="container">
  <div class="card" id="leftPanel">
    <div style="font-weight:700;margin-bottom:8px">Daftar Petugas Aktif</div>
    <div id="list"></div>
  </div>
  <div class="card" id="rightPanel">
    <div style="font-weight:700;margin-bottom:8px">Peta & Detail</div>
    <div id="map"></div>
    <div id="detail" style="margin-top:12px"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

<script>
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBlW0bCNzY9X-6u8jF5Bqt0TT9egcYC-VU",
  authDomain: "patroilgptracking.firebaseapp.com",
  databaseURL: "https://patroilgptracking-default-rtdb.firebaseio.com",
  projectId: "patroilgptracking",
  storageBucket: "patroilgptracking.firebasestorage.app",
  messagingSenderId: "653208547594",
  appId: "1:653208547594:web:7c187fc4a4fba5b815caf3"
};

firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();

// Simple anonymous sign-in for admin UI
firebase.auth().signInAnonymously().catch(e=>console.warn('admin auth',e));

const listEl = document.getElementById('list');
const detailEl = document.getElementById('detail');

// Leaflet map
const map = L.map('map').setView([-6.2, 106.8], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
const markers = {};

// listen to /live
const liveRef = db.ref('/live');
liveRef.on('value', snap => {
  const data = snap.val() || {} ;
  listEl.innerHTML = '';
  const keys = Object.keys(data);
  if(keys.length===0) { listEl.innerHTML = '<div class="small">Belum ada petugas aktif</div>'; return; }
  keys.sort((a,b)=> (data[b].presence && data[b].presence.lastSeen || 0) - (data[a].presence && data[a].presence.lastSeen || 0));
  keys.forEach(k=>{ const node = data[k]; const pres = node.presence || {}; const lastGps = node.lastGps || null;
    const name = pres.officerName || k; const lastSeen = pres.lastSeen ? new Date(pres.lastSeen).toLocaleTimeString() : '-';
    const wrapper = document.createElement('div'); wrapper.style.padding='8px'; wrapper.style.marginBottom='8px'; wrapper.style.border='1px solid #eee'; wrapper.style.borderRadius='8px';
    wrapper.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700">${'{'}${'name'}${'}'}</div><div class="small">${'{'}${'lastSeen'}${'}'}</div></div><div class="small">GPS: ${'{'}${'lastGps' + ''}${'}'}</div>`;
    wrapper.onclick = ()=> showDetail(k,node);
    listEl.appendChild(wrapper);

    if(lastGps && lastGps.lat && lastGps.lon){
      if(markers[k]){ markers[k].setLatLng([lastGps.lat, lastGps.lon]); }
      else { markers[k] = L.marker([lastGps.lat, lastGps.lon]).addTo(map).bindPopup(name); }
    }
  });
});

function showDetail(id,node){
  const pres = node.presence || {}; const lastGps = node.lastGps || null;
  let html = `<h3>${'{'}${'pres.officerName || id'}${'}'}</h3><div class="small"><strong>Last seen:</strong> ${'{'}${'pres.lastSeen? new Date(pres.lastSeen).toLocaleString() : \'-\''}${'}'}</div><div class="small"><strong>GPS:</strong> ${'{'}${'lastGps? (lastGps.lat.toFixed(6)+\', \' + lastGps.lon.toFixed(6)) : \'No GPS\''}${'}'}</div>`;
  if(node.photos){ html += '<div style="margin-top:8px"><strong>Photos</strong></div>'; Object.values(node.photos).slice().reverse().forEach(p=>{ html += `<div style="margin-top:6px"><a href="${'{'}${'p.url'}${'}'}" target="_blank"><img src="${'{'}${'p.url'}${'}'}" style="width:240px;height:160px;object-fit:cover;border:1px solid #ddd"></a><div class="small">Uploaded: ${'{'}${'p.uploadedAt? new Date(p.uploadedAt).toLocaleString() : \'-\''}${'}'}</div></div>`; }); }
  if(node.signature) html += `<div style="margin-top:8px"><strong>Signature</strong><div><img src="${'{'}${'node.signature.url'}${'}'}" style="width:320px;height:120px;object-fit:contain;border:1px solid #eee"></div></div>`;
  detailEl.innerHTML = html;
}
</script>

<script>

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCnooeRNZRzTPDvOWIAH3pXbkIryZgJuic",
  authDomain: "silitpitik7373.firebaseapp.com",
  projectId: "silitpitik7373",
  databaseURL: "https://silitpitik7373-default-rtdb.firebaseio.com",
  storageBucket: "silitpitik7373.appspot.com",
  messagingSenderId: "314430704796",
  appId: "1:314430704796:web:2147f3a3a74bfa7affb159"
};


if(!window.firebase || !firebase.apps || !firebase.apps.length) {
  (function(){var s=document.createElement('script'); s.src='https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js'; s.onload=function(){
    var a=document.createElement('script'); a.src='https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js'; document.head.appendChild(a);
    var b=document.createElement('script'); b.src='https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js'; document.head.appendChild(b);
    b.onload=function(){
      try{ firebase.initializeApp(FIREBASE_CONFIG); firebase.auth().signInAnonymously().catch(function(err){console.warn('Auth err', err);}); }catch(e){console.warn('init err', e);}
    };
    document.head.appendChild(s);
  }; document.head.appendChild(s);})();
}

const CLOUDINARY = {
  cloudName: "dowaohqkh",
  uploadPreset: "Patroli"
};

function uploadImageToCloudinary(file) {
  return new Promise(function(resolve, reject) {
    if(!file) return reject('No file');
    var url = 'https://api.cloudinary.com/v1_1/' + CLOUDINARY.cloudName + '/upload';
    var fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', CLOUDINARY.uploadPreset);
    var xhr = new XMLHttpRequest();
    xhr.open('POST', url, true);
    xhr.onreadystatechange = function(){ if(xhr.readyState == 4) { if(xhr.status==200){ var res = JSON.parse(xhr.responseText); resolve(res.secure_url); } else { reject(xhr.responseText); } } };
    xhr.send(fd);
  });
}

function savePatrolData(uid, payload) {
  if(!uid) uid = 'anon_' + (firebase.auth().currentUser ? firebase.auth().currentUser.uid : 'guest');
  var ref = firebase.database().ref('patroli/' + uid);
  return ref.push(payload);
}

window.CLOUDINARY = CLOUDINARY;
window.uploadImageToCloudinary = uploadImageToCloudinary;
window.savePatrolData = savePatrolData;
</script>
</body>
</html>
