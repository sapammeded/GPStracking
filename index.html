<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Patroli (Tactical Red)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>

  <style>
    :root{
      --bg:#0f0b0b;
      --card:#1a0f0f;
      --accent:#b81f1f; /* tactical red */
      --muted:#c6c6c6;
      --glass: rgba(255,255,255,0.03);
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,"Helvetica Neue",Arial;}
    body{background:linear-gradient(180deg,#070506 0%, #0d0b0b 100%); color:var(--muted);}
    .topbar{display:flex;align-items:center;gap:12px;padding:14px 16px;background:linear-gradient(90deg, rgba(184,31,31,0.95), rgba(120,12,12,0.95));box-shadow:0 6px 18px rgba(0,0,0,0.45);color:#fff}
    .brand{font-weight:800;font-size:18px;letter-spacing:0.6px}
    .layout{display:grid;grid-template-columns:360px 1fr;gap:12px;padding:12px;max-width:1400px;margin:14px auto;}
    .panel{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 8px 30px rgba(0,0,0,0.5);overflow:hidden}
    .list-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    #petugasList{height:calc(100vh - 180px);overflow:auto;padding-right:6px}
    .petugas-item{border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:10px;margin-bottom:10px;cursor:pointer;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));transition:all .12s}
    .petugas-item:hover{transform:translateY(-3px);box-shadow:0 10px 30px rgba(184,31,31,0.08)}
    .petugas-name{font-weight:700;color:#fff}
    .petugas-sub{font-size:12px;color:rgba(255,255,255,0.65)}
    #map{height:calc(100vh - 120px);border-radius:10px}
    .detail{margin-top:10px;color:var(--muted);font-size:13px}
    .card-photo{width:100%;max-width:320px;border-radius:8px;margin-top:8px;display:block}
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,0.25);color:#fff;font-size:13px;margin-right:6px}
    .small{font-size:13px;color:rgba(255,255,255,0.7)}
    .footer-note{font-size:12px;color:rgba(255,255,255,0.45);margin-top:8px}
    /* responsive */
    @media (max-width:980px){ .layout{grid-template-columns:1fr; padding:8px;} #map{height:320px} #petugasList{height:220px} }
    /* debug overlay small */
    #dbg{position:fixed;left:8px;right:8px;bottom:8px;max-height:36vh;overflow:auto;background:rgba(0,0,0,0.85);color:#fff;padding:10px;border-radius:8px;font-size:12px;display:none;z-index:999999}
    #dbg button{margin-top:8px;padding:6px 10px;border-radius:8px;border:0;background:var(--accent);color:#fff}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">PATROLI — ADMIN MONITOR</div>
    <div style="margin-left:8px;color:#fff;opacity:0.95">Mode: <strong style="margin-left:6px;padding:4px 8px;border-radius:8px;background:rgba(0,0,0,0.15)">Tactical Red</strong></div>
    <div style="margin-left:auto;color:#fff;display:flex;gap:10px;align-items:center">
      <div class="chip" id="statusOnline">Offline</div>
      <div class="chip" id="countActive">0 aktif</div>
    </div>
  </div>

  <div class="layout">
    <div class="panel">
      <div class="list-title">
        <div>
          <div style="font-weight:800;color:#fff">Petugas Aktif</div>
          <div class="small">Klik nama untuk detail</div>
        </div>
        <div style="text-align:right">
          <button id="btnRefresh" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer">Refresh</button>
        </div>
      </div>

      <div id="petugasList">
        <div class="small">Memuat...</div>
      </div>

      <div class="footer-note">Realtime updates via Firebase — Cloudinary images</div>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 8px 0;color:#fff">Peta & Detail</h3>
      <div id="map"></div>
      <div id="detail" class="detail"></div>
    </div>
  </div>

  <!-- Debug overlay -->
  <div id="dbg"><strong>DEBUG</strong><div id="dbgout" style="margin-top:8px"></div><button onclick="document.getElementById('dbg').style.display='none'">Close</button></div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- Leaflet -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

  <script>
  // ---------------------------
  // CONFIG (sesuaikan kalau perlu)
  // ---------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyCnooeRNZRzTPDvOWIAH3pXbkIryZgJuic",
    authDomain: "silitpitik7373.firebaseapp.com",
    databaseURL: "https://silitpitik7373-default-rtdb.firebaseio.com",
    projectId: "silitpitik7373",
    storageBucket: "silitpitik7373.appspot.com",
    messagingSenderId: "314430704796",
    appId: "1:314430704796:web:2147f3a3a74bfa7affb159"
  };

  // Cloudinary info (bukan sensitif)
  const CLOUDINARY = { cloudName: "dowaohqkh", uploadPreset: "Patroli" };

  // ---------------------------
  // Init firebase + anonymous auth
  // ---------------------------
  try{
    if(!window.firebase || !firebase.apps || !firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    // sign in anonymously to enable DB read (if rules require auth)
    firebase.auth().signInAnonymously().catch(()=>{ /* ignore */ });
  }catch(e){
    console.error('firebase init err', e);
    showDbg('init err: '+String(e));
  }

  const db = firebase.database();

  // ---------------------------
  // Debug helper
  // ---------------------------
  function showDbg(msg){
    try{
      document.getElementById('dbgout').innerHTML += '<div style="margin-bottom:6px">'+String(msg)+'</div>';
      document.getElementById('dbg').style.display = 'block';
    }catch(e){ console.log('dbg fail', e); }
  }
  window.onerror = function(msg,src,line){ showDbg('ERROR: '+msg+' ('+src+':'+line+')'); };

  // ---------------------------
  // Map init
  // ---------------------------
  const map = L.map('map', { zoomControl:true }).setView([-6.2, 106.8], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution: ''}).addTo(map);

  // marker store
  const markers = {};
  const markerIcons = {};
  function makeIcon(color){
    // simple circle marker icon using DivIcon
    return L.divIcon({className:'custom-marker', html:`<div style="background:${color};width:14px;height:14px;border-radius:50%;border:2px solid #111"></div>`, iconSize:[18,18], iconAnchor:[9,9]});
  }

  // colors: active = bright red, stale = gray
  markerIcons.active = makeIcon('#ff3b3b');
  markerIcons.stale = makeIcon('#888');

  // ---------------------------
  // UI helpers
  // ---------------------------
  const listEl = document.getElementById('petugasList');
  const detailEl = document.getElementById('detail');
  const statusOnline = document.getElementById('statusOnline');
  const countActive = document.getElementById('countActive');
  document.getElementById('btnRefresh').onclick = ()=>{ // manual refresh: re-read live
    loadLiveOnce();
  };

  function clearList(){
    listEl.innerHTML = '';
  }
  function makeItem(uid, meta){
    const div = document.createElement('div');
    div.className = 'petugas-item';
    const name = (meta.presence && meta.presence.officerName) ? meta.presence.officerName : uid;
    const last = (meta.presence && meta.presence.lastSeen) ? new Date(meta.presence.lastSeen).toLocaleString() : '-';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div class="petugas-name">${escapeHtml(name)}</div><div class="petugas-sub">Last: ${last}</div></div><div class="small">${uid}</div></div>`;
    div.onclick = ()=> openDetail(uid);
    return div;
  }

  // escape helper
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];}); }

  // ---------------------------
  // Real-time listeners
  // ---------------------------
  // Read live nodes (presence + lastGps)
  let liveRef = db.ref('live');
  liveRef.on('value', snap=>{
    const data = snap.val() || {};
    renderLive(data);
  }, err=>{
    showDbg('liveRef err: '+(err && err.message));
  });

  // Render live list + map markers
  function renderLive(data){
    clearList();
    const uids = Object.keys(data || {});
    countActive.innerText = (uids.length)+' aktif';
    if(uids.length>0) statusOnline.innerText = 'Online';
    else statusOnline.innerText = 'Offline';

    // update markers
    uids.forEach(uid=>{
      const item = data[uid] || {};
      const gps = item.lastGps || null;
      // create list item
      const node = makeItem(uid, item);
      listEl.appendChild(node);

      if(gps && gps.lat && gps.lon){
        const lat = Number(gps.lat), lon = Number(gps.lon);
        if(markers[uid]){
          markers[uid].setLatLng([lat, lon]);
        } else {
          markers[uid] = L.marker([lat, lon], {icon: markerIcons.active}).addTo(map).bindPopup(escapeHtml((item.presence && item.presence.officerName) || uid));
        }
      }
    });
  }

  // ---------------------------
  // Detail view: shows patroli/{uid} items
  // ---------------------------
  function openDetail(uid){
    detailEl.innerHTML = '<div class="small">Memuat data...</div>';
    db.ref('patroli').child(uid).limitToLast(30).once('value').then(snap=>{
      const val = snap.val() || {};
      let keys = Object.keys(val);
      if(keys.length===0){ detailEl.innerHTML = '<div class="small">Tidak ada laporan.</div>'; return; }
      // order descending by timestamp if present
      const arr = keys.map(k=>({k, v: val[k]})).sort((a,b)=> (b.v.time||0) - (a.v.time||0));
      let html = `<div style="display:flex;gap:8px;align-items:center"><div style="font-weight:700;color:#fff">${escapeHtml(uid)}</div><div class="small"> (${arr.length} laporan)</div></div>`;
      arr.forEach(it=>{
        const p = it.v;
        const t = p.time ? new Date(p.time).toLocaleString() : '-';
        html += `<div style="margin-top:10px;padding:10px;border-radius:10px;background:var(--glass);border:1px solid rgba(255,255,255,0.02)"><div style="font-weight:700;color:#fff">${escapeHtml(p.desc || 'Laporan')}</div><div class="small">${t} — ${escapeHtml(p.officer || '')}</div>`;
        if(p.photo){
          html += `<img src="${escapeHtml(p.photo)}" class="card-photo" alt="foto">`;
        }
        html += `</div>`;
      });
      detailEl.innerHTML = html;
      // center map to last gps from /live/{uid}
      db.ref('live').child(uid).once('value').then(snap2=>{
        const live = snap2.val();
        if(live && live.lastGps && live.lastGps.lat && live.lastGps.lon){
          try{ map.setView([live.lastGps.lat, live.lastGps.lon], 14); if(markers[uid]) markers[uid].openPopup(); }catch(e){/* ignore */ }
        }
      });
    }).catch(err=>{
      showDbg('detail load err: '+(err && err.message));
    });
  }

  // ---------------------------
  // Utility: initial one-time load
  // ---------------------------
  function loadLiveOnce(){
    db.ref('live').once('value').then(snap=>{
      renderLive(snap.val() || {});
    }).catch(err=>showDbg('once load err: '+(err && err.message)));
  }

  // quick initial load
  loadLiveOnce();

  // ---------------------------
  // Small heartbeat indicator for admin page
  // ---------------------------
  setInterval(()=>{
    // ping simple to verify DB reachable
    db.ref('.info/connected').once('value').then(snap=>{
      const ok = snap.val() === true;
      if(ok){ statusOnline.style.background = 'rgba(0,0,0,0.18)'; statusOnline.innerText = 'Connected'; }
    }).catch(e=>{/* ignore */});
  }, 8000);

  // ---------------------------
  // Final note to admin: help text
  // ---------------------------
  (function addHelp(){
    const help = document.createElement('div');
    help.style.marginTop='12px';
    help.style.fontSize='13px';
    help.style.color='rgba(255,255,255,0.7)';
    help.innerHTML = '<div style="font-weight:700;color:#fff;margin-bottom:6px">Petunjuk singkat</div><div class="small">Buka halaman User (petugas) → mulai patroli → ambil foto → data dan foto akan muncul di sini secara realtime. Jika kosong: cek https://silitpitik7373-default-rtdb.firebaseio.com/patroli.json</div>';
    document.querySelector('.panel:nth-child(2)').appendChild(help);
  })();

  // ---------------------------
  // Auto-hide debug overlay after 7s if no errors
  // ---------------------------
  setTimeout(()=>{ try{ if(document.getElementById('dbgout').innerHTML.trim()==='') document.getElementById('dbg').style.display='none'; else document.getElementById('dbg').style.display='block'; }catch(e){} }, 8000);

  </script>
</body>
</html>