<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Patroli — Realtime Monitor (Extended)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- SheetJS (for XLSX export) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#070707; --card:#0f0f10; --muted:#bfbfbf;
      --accent:#b71c1c; --accent-2:#ff5252;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;color:#eee;background:linear-gradient(180deg,#050505,#0b0b0b)}
    .wrap{display:flex;gap:12px;padding:12px;height:100vh;box-sizing:border-box}
    .left{width:40%;min-width:320px;display:flex;flex-direction:column;gap:12px}
    .right{flex:1;display:flex;flex-direction:column;gap:12px}
    .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.6);overflow:hidden}
    .header{display:flex;align-items:center;gap:12px}
    .title{font-weight:800;color:var(--accent-2);font-size:18px}
    #list{max-height:40vh;overflow:auto;display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .item{display:flex;gap:10px;padding:8px;border-radius:8px;align-items:center;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
    .item:hover{transform:translateY(-2px);transition:all .12s}
    .thumb{width:68px;height:68px;border-radius:8px;object-fit:cover;background:#111}
    .meta h4{margin:0;font-size:15px}
    .meta p{margin:4px 0 0;color:var(--muted);font-size:13px}
    .mapwrap{height:calc(100vh - 100px);border-radius:12px;overflow:hidden}
    #map{height:100%;width:100%}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:8px 10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .filters{display:flex;gap:8px;align-items:center}
    .small{font-size:13px;color:var(--muted)}
    .detailphotos{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .detailphotos img{width:140px;height:100px;border-radius:8px;object-fit:cover}
    .sig{width:180px;height:100px;border-radius:8px;background:#0b0b0b;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.03)}
    .notice{color:var(--muted);font-size:13px;margin-top:8px}
    @media(max-width:900px){.wrap{flex-direction:column}.left{width:100%}.mapwrap{height:50vh}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="left">
      <div class="card header">
        <div>
          <div class="title">Patroli — Realtime Monitor (Extended)</div>
          <div class="small">Tema: Merah tactical • Live via Firebase RTDB</div>
        </div>
        <div style="margin-left:auto;text-align:right">
          <div style="font-weight:700;color:var(--accent)">Status: <span id="conn">connecting...</span></div>
          <div class="small">Auto refresh • Notif suara</div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Kontrol</strong>
          <div class="controls">
            <button id="btnFollow" class="btn">Follow: Off</button>
            <button id="btnExportCSV" class="btn">Export CSV</button>
            <button id="btnExportXLSX" class="btn">Export XLSX</button>
          </div>
        </div>

        <div style="height:8px"></div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <div class="filters">
            <label class="small">Shift:</label>
            <select id="shiftFilter" class="btn">
              <option value="">— semua —</option>
              <option value="pagi">PAGI</option>
              <option value="siang">SIANG</option>
              <option value="malam">MALAM</option>
            </select>
          </div>

          <div class="filters">
            <label class="small">From:</label>
            <input id="fromTs" type="datetime-local" class="btn"/>
            <label class="small">To:</label>
            <input id="toTs" type="datetime-local" class="btn"/>
          </div>

          <div class="filters">
            <label class="small">Area (bbox):</label>
            <input id="bbox" placeholder="southWestLat,southWestLng,northEastLat,northEastLng" class="btn" style="min-width:260px"/>
          </div>

          <button id="btnApplyFilter" class="btn primary">Apply Filter</button>
          <button id="btnClearFilter" class="btn">Clear</button>
        </div>

        <div id="list" aria-live="polite"></div>
        <div id="empty" class="notice">Tidak ada data.</div>
      </div>

      <div class="card">
        <strong>Detail Petugas</strong>
        <div id="detailTitle" class="small" style="margin-top:8px">Pilih item di daftar untuk lihat detail</div>
        <div style="display:flex;gap:12px;margin-top:10px;align-items:flex-start">
          <div style="flex:1">
            <div id="detailMain" style="min-height:120px"></div>
            <div id="photos" class="detailphotos"></div>
            <div class="notice" id="lastUpdate">Last update: -</div>
          </div>
          <div style="width:220px">
            <div class="sig" id="signature">signature</div>
            <div class="notice" style="margin-top:8px">Petunjuk: klik item untuk follow / pan</div>
          </div>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="card mapwrap">
        <div id="map"></div>
      </div>
    </div>
  </div>

  <!-- Audio notif -->
  <audio id="pingSound">
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YQAAAAA=" type="audio/wav">
  </audio>

<script>
/* ============= CONFIG =============
   Sesuaikan firebaseConfig di sini:
===================================== */
const firebaseConfig = {
  apiKey: "AIzaSyCnooeRNZRzTPDvOWIAH3pXbkIryZgJuic",
  authDomain: "silitpitik7373.firebaseapp.com",
  databaseURL: "https://silitpitik7373-default-rtdb.firebaseio.com",
  projectId: "silitpitik7373",
  storageBucket: "silitpitik7373.firebasestorage.app",
  messagingSenderId: "314430704796",
  appId: "1:314430704796:web:2147f3a3a74bfa7affb159"
};
firebase.initializeApp(firebaseConfig);
const dbRef = firebase.database().ref('/patroli');

/* ============= MAP ============= */
const map = L.map('map', {zoomControl:false}).setView([-6.2,106.8166], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);
L.control.zoom({position:'topleft'}).addTo(map);

const markers = {}; // key -> marker
let currentSelected = null;
let followMode = false;

/* ============= UI elems ============= */
const connEl = document.getElementById('conn');
const listEl = document.getElementById('list');
const emptyEl = document.getElementById('empty');
const detailMain = document.getElementById('detailMain');
const photosEl = document.getElementById('photos');
const sigEl = document.getElementById('signature');
const lastUpdateEl = document.getElementById('lastUpdate');
const pingSound = document.getElementById('pingSound');

/* filters */
const shiftFilter = document.getElementById('shiftFilter');
const fromTs = document.getElementById('fromTs');
const toTs = document.getElementById('toTs');
const bboxInput = document.getElementById('bbox');
const btnApplyFilter = document.getElementById('btnApplyFilter');
const btnClearFilter = document.getElementById('btnClearFilter');
const btnFollow = document.getElementById('btnFollow');
const btnExportCSV = document.getElementById('btnExportCSV');
const btnExportXLSX = document.getElementById('btnExportXLSX');

let latestSnapshot = {}; // cache

/* sound function */
function playNotif(){
  try{
    pingSound.currentTime = 0;
    pingSound.play().catch(()=>{ /* autoplay blocked */ });
  }catch(e){}
}

/* helper format */
function fmtTime(ts){ if(!ts) return '-'; return new Date(Number(ts)).toLocaleString(); }
function safe(s){ return s?String(s):''; }

/* render list + markers */
function renderAll(dataObj, applyFilter=true){
  latestSnapshot = dataObj || {};
  listEl.innerHTML = '';
  const keys = Object.keys(dataObj || {});
  if(!keys.length){ emptyEl.style.display='block'; return; } else emptyEl.style.display='none';

  // apply filters
  const shift = shiftFilter.value;
  const from = fromTs.value ? (new Date(fromTs.value)).getTime() : null;
  const to = toTs.value ? (new Date(toTs.value)).getTime() : null;
  const bbox = bboxInput.value ? bboxInput.value.split(',').map(Number) : null; // swLat,swLng,neLat,neLng

  // sort by timestamp desc
  keys.sort((a,b)=> (Number((dataObj[b]||{}).timestamp||0) - Number((dataObj[a]||{}).timestamp||0)));

  let anyVisible = false;
  keys.forEach(key=>{
    const d = dataObj[key] || {};
    // filter shift
    if(shift && String((d.shift||'')).toLowerCase() !== shift.toLowerCase()) return;
    // filter time
    if(from && (!d.timestamp || Number(d.timestamp) < from)) return;
    if(to && (!d.timestamp || Number(d.timestamp) > to)) return;
    // filter bbox
    if(bbox && bbox.length===4 && d.lat && d.lng){
      const [swLat,swLng,neLat,neLng] = bbox;
      const lat = Number(d.lat), lng = Number(d.lng);
      if(!(lat>=swLat && lat<=neLat && lng>=swLng && lng<=neLng)) return;
    }

    anyVisible = true;
    const photo = (d.photos && d.photos[0]) || d.photoUrl || '';
    const li = document.createElement('div');
    li.className='item';
    li.innerHTML = `
      <div style="flex:0 0 68px">${photo? `<img class="thumb" src="${photo}" alt="thumb">` : `<div class="thumb" style="display:flex;align-items:center;justify-content:center;color:var(--muted)">No</div>`}</div>
      <div class="meta">
        <h4>${safe(d.name||key)}</h4>
        <p>${safe(d.description||'—')}</p>
        <p class="small">${d.lat? ('Pos: '+Number(d.lat).toFixed(5)+', '+Number(d.lng).toFixed(5)) : 'posisi kosong'} • ${d.timestamp?fmtTime(d.timestamp):'no ts'}</p>
      </div>
      <div style="margin-left:auto"><div style="font-weight:700;color:var(--accent)">${safe(d.status||'PATROLI')}</div></div>
    `;
    li.addEventListener('click', ()=>{
      selectItem(key, d);
      if(d.lat && d.lng){
        map.panTo([Number(d.lat), Number(d.lng)], {animate:true});
      }
      // toggle follow when pick
      followMode = true;
      btnFollow.innerText = 'Follow: On';
    });
    listEl.appendChild(li);

    // marker: add/update
    if(d.lat && d.lng){
      const lat = Number(d.lat), lng = Number(d.lng);
      if(markers[key]){
        markers[key].setLatLng([lat,lng]);
        markers[key].setPopupContent(`<strong>${safe(d.name||key)}</strong><br>${safe(d.description||'')}`);
      } else {
        const m = L.marker([lat,lng], {title: d.name||key}).addTo(map);
        m.bindPopup(`<strong>${safe(d.name||key)}</strong><br>${safe(d.description||'')}`);
        markers[key] = m;
      }
      // if follow and selected -> pan
      if(followMode && currentSelected===key){
        map.panTo([lat,lng]);
      }
    } else {
      if(markers[key]){ map.removeLayer(markers[key]); delete markers[key]; }
    }
  });

  if(!anyVisible){
    listEl.innerHTML = '<div class="notice">Filter menghasilkan 0 item.</div>';
  }
}

/* select item */
function selectItem(key,data){
  currentSelected = key;
  document.getElementById('detailTitle').innerText = `${safe(data.name||key)} • ${fmtTime(data.timestamp)}`;
  detailMain.innerHTML = `<div style="color:var(--muted)">${safe(data.description||'—')}</div>`;
  // photos
  photosEl.innerHTML = '';
  const photos = data.photos || (data.photoUrl ? [data.photoUrl] : []);
  if(Array.isArray(photos) && photos.length){
    photos.forEach(u=>{
      const img = document.createElement('img');
      img.src = u;
      img.alt = 'foto';
      photosEl.appendChild(img);
    });
  } else {
    photosEl.innerHTML = '<div class="notice">No photos</div>';
  }
  // signature
  if(data.signatureUrl){
    sigEl.innerHTML = `<img src="${data.signatureUrl}" style="max-width:100%;max-height:100%;object-fit:contain"/>`;
  } else {
    sigEl.innerText = 'tidak ada';
  }
}

/* Realtime listeners & notif logic */
let firstLoad = true;
dbRef.on('value', snapshot=>{
  const val = snapshot.val() || {};
  connEl.innerText = 'connected';
  const prev = latestSnapshot || {};
  // Detect new or changed keys for notif
  const changedKeys = [];
  Object.keys(val).forEach(k=>{
    const newTs = Number((val[k]||{}).timestamp || 0);
    const oldTs = Number((prev[k]||{}).timestamp || 0);
    if(newTs && newTs !== oldTs){
      changedKeys.push(k);
    }
  });
  // play notif if not first load and changes exist
  if(!firstLoad && changedKeys.length>0){
    playNotif();
    // flash highlight for updated items
    changedKeys.forEach(k=>{
      // find corresponding DOM item and flash (simple)
      const nodes = Array.from(listEl.children);
      nodes.forEach(n=>{
        if(n.querySelector('h4') && n.querySelector('h4').innerText === (val[k].name || k)){
          n.style.boxShadow = '0 0 0 3px rgba(183,28,28,0.15)';
          setTimeout(()=> n.style.boxShadow = '', 2200);
        }
      });
    });
  }
  firstLoad = false;
  latestSnapshot = val;
  renderAll(val);
  lastUpdateEl.innerText = 'Last update: ' + fmtTime(Date.now());
}, err => {
  connEl.innerText = 'error';
  listEl.innerHTML = `<div class="notice">DB error: ${err.message}</div>`;
});

/* child_added alternative: immediate notif for new -> optional */
dbRef.on('child_added', snap=>{
  // if it's not first load, play notif
  if(!firstLoad) playNotif();
});

/* ============= Filter events ============= */
btnApplyFilter.addEventListener('click', ()=>{
  renderAll(latestSnapshot, true);
});
btnClearFilter.addEventListener('click', ()=>{
  shiftFilter.value = '';
  fromTs.value = '';
  toTs.value = '';
  bboxInput.value = '';
  renderAll(latestSnapshot);
});

/* ============= Follow toggle ============= */
btnFollow.addEventListener('click', ()=>{
  followMode = !followMode;
  btnFollow.innerText = 'Follow: ' + (followMode? 'On' : 'Off');
});

/* ============= Export CSV/XLSX ============= */
function flattenForExport(obj){
  // returns array of rows
  return Object.keys(obj||{}).map(k=>{
    const d = obj[k] || {};
    return {
      id: k,
      name: d.name || '',
      lat: d.lat || '',
      lng: d.lng || '',
      description: d.description || '',
      timestamp: d.timestamp || '',
      timestamp_readable: d.timestamp ? new Date(Number(d.timestamp)).toLocaleString() : '',
      photoUrl: d.photoUrl || (d.photos? d.photos.join('|') : ''),
      signatureUrl: d.signatureUrl || '',
      shift: d.shift || '',
      status: d.status || ''
    };
  });
}

btnExportCSV.addEventListener('click', ()=>{
  const rows = flattenForExport(latestSnapshot);
  if(!rows.length){ alert('Tidak ada data'); return; }
  const keys = Object.keys(rows[0]);
  const csv = [keys.join(',')].concat(rows.map(r=> keys.map(k=> `"${String(r[k]||'').replace(/"/g,'""')}"`).join(','))).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'patroli_export.csv'; a.click(); URL.revokeObjectURL(url);
});

btnExportXLSX.addEventListener('click', ()=>{
  const rows = flattenForExport(latestSnapshot);
  if(!rows.length){ alert('Tidak ada data'); return; }
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Patroli');
  XLSX.writeFile(wb, 'patroli_export.xlsx');
});

/* utility: select first visible item on click load */
function trySelectFirst(){
  const firstKey = Object.keys(latestSnapshot || {})[0];
  if(firstKey) selectItem(firstKey, latestSnapshot[firstKey]);
}
setTimeout(()=> trySelectFirst(), 1500);

/* ============= Auto-recenter follow loop ============= */
setInterval(()=>{
  if(followMode && currentSelected && markers[currentSelected]){
    map.panTo(markers[currentSelected].getLatLng(), {animate:true});
  }
}, 3000);

/* ============= End of script ============= */
</script>

</body>
</html>