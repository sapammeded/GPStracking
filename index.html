<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Mapping Tool - All Features Working</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif;
            background: #000;
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 100vh;
        }
        
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 1000;
            background: rgba(0,0,0,0.9);
            padding: 12px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid #00ff88;
        }
        
        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: 15px;
            background: #00ff88;
            color: black;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            min-width: 70px;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn-pause {
            background: #ff9800;
        }
        
        .btn-stop {
            background: #ff4444;
            color: white;
        }
        
        .btn-save {
            background: #2196f3;
            color: white;
        }
        
        .btn-mode {
            background: #9c27b0;
            color: white;
        }
        
        .btn-photo {
            background: #ff4081;
            color: white;
        }
        
        .status-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.95);
            padding: 15px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            min-width: 220px;
            border: 2px solid #333;
        }
        
        .status-item {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .status-label {
            color: #ccc;
        }
        
        .status-value {
            font-weight: bold;
            color: #00ff88;
        }
        
        .accuracy-high { color: #00ff88; }
        .accuracy-medium { color: #ff9800; }
        .accuracy-low { color: #ff4444; }
        
        .mode-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px 15px;
            border-radius: 15px;
            font-weight: bold;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 2px solid;
        }
        
        .mode-outdoor { 
            background: #00ff88; 
            color: black; 
            border-color: #00c853;
        }
        
        .mode-indoor { 
            background: #ff9800; 
            color: black; 
            border-color: #f57c00;
        }
        
        .tracking-active {
            animation: pulse 1.5s infinite;
        }
        
        /* COMPASS STYLES */
        .compass {
            position: fixed;
            top: 80px;
            right: 10px;
            width: 80px;
            height: 80px;
            z-index: 1000;
        }
        
        .compass-circle {
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            border: 2px solid #00ff88;
            position: relative;
            backdrop-filter: blur(10px);
        }
        
        .compass-needle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 35px;
            background: #ff4444;
            transform-origin: 50% 100%;
            transform: translate(-50%, -100%) rotate(0deg);
            transition: transform 0.1s ease;
        }
        
        .compass-direction {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            font-weight: bold;
            color: #00ff88;
        }
        
        .compass-n {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #ff4444;
            font-weight: bold;
        }
        
        .compass-e {
            position: absolute;
            top: 50%;
            right: 5px;
            transform: translateY(-50%);
            font-size: 12px;
            color: #00ff88;
        }
        
        .compass-s {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #00ff88;
        }
        
        .compass-w {
            position: absolute;
            top: 50%;
            left: 5px;
            transform: translateY(-50%);
            font-size: 12px;
            color: #00ff88;
        }
        
        .movement-info {
            position: fixed;
            top: 170px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            padding: 10px;
            border-radius: 10px;
            font-size: 11px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid #333;
            min-width: 120px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .download-options {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 20px;
            border-radius: 15px;
            z-index: 2000;
            border: 2px solid #00ff88;
            backdrop-filter: blur(10px);
        }
        
        .format-btn {
            display: block;
            width: 200px;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            background: #333;
            color: white;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
        }
        
        .format-btn:hover {
            background: #00ff88;
            color: black;
        }
        
        .photo-marker {
            background: #ff4081 !important;
            border: 2px solid white;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="status-panel">
        <div class="status-item">
            <span class="status-label">üìç Status:</span>
            <span class="status-value" id="trackStatus">READY</span>
        </div>
        <div class="status-item">
            <span class="status-label">üéØ Akurasi:</span>
            <span class="status-value" id="accuracyInfo">-</span>
        </div>
        <div class="status-item">
            <span class="status-label">üìä Titik:</span>
            <span class="status-value" id="pointCount">0</span>
        </div>
        <div class="status-item">
            <span class="status-label">üìè Jarak:</span>
            <span class="status-value" id="distance">0</span>m
        </div>
        <div class="status-item">
            <span class="status-label">üïí Durasi:</span>
            <span class="status-value" id="duration">0</span>s
        </div>
        <div class="status-item">
            <span class="status-label">üì∏ Foto:</span>
            <span class="status-value" id="photoCount">0</span>
        </div>
    </div>
    
    <div class="mode-indicator mode-outdoor" id="modeIndicator">
        OUTDOOR GPS
    </div>
    
    <!-- COMPASS -->
    <div class="compass">
        <div class="compass-circle">
            <div class="compass-n">N</div>
            <div class="compass-e">E</div>
            <div class="compass-s">S</div>
            <div class="compass-w">W</div>
            <div class="compass-needle" id="compassNeedle"></div>
            <div class="compass-direction" id="compassDirection">0¬∞</div>
        </div>
    </div>
    
    <div class="movement-info" id="movementInfo">
        Arah: -<br>
        Gerakan: -
    </div>
    
    <div class="controls">
        <button class="btn" id="startBtn" onclick="startTracking()">‚ñ∂ START</button>
        <button class="btn btn-pause hidden" id="pauseBtn" onclick="pauseTracking()">‚è∏ PAUSE</button>
        <button class="btn" onclick="addManualPoint()">üìç MARK</button>
        <button class="btn btn-photo" onclick="takePhoto()">üì∏ PHOTO</button>
        <button class="btn btn-mode" onclick="switchMode()">üîÄ MODE</button>
        <button class="btn btn-stop hidden" id="stopBtn" onclick="stopTracking()">‚èπ STOP</button>
        <button class="btn btn-save" onclick="showDownloadOptions()">üíæ SAVE</button>
    </div>

    <div class="download-options hidden" id="downloadOptions">
        <h3 style="text-align: center; margin-bottom: 15px;">üì• DOWNLOAD FORMAT</h3>
        <button class="format-btn" onclick="downloadData('json')">üìÑ JSON (Recommended)</button>
        <button class="format-btn" onclick="downloadData('gpx')">üó∫Ô∏è GPX (Maps Software)</button>
        <button class="format-btn" onclick="downloadData('kml')">üåç KML (Google Earth)</button>
        <button class="format-btn" onclick="downloadData('csv')">üìä CSV (Excel)</button>
        <button class="format-btn" style="background: #ff4444; margin-top: 15px;" onclick="hideDownloadOptions()">‚ùå TUTUP</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables - SEMUA VARIABEL DI SINI
        let map, currentMarker, trackPolyline;
        let points = [];
        let isTracking = false;
        let isPaused = false;
        let watchId = null;
        let totalDistance = 0;
        let stepCount = 0;
        let startTime = null;
        let durationInterval = null;
        let currentMode = 'outdoor';
        let gpsStabilized = false;
        let photoCount = 0;
        
        // Compass & Movement tracking
        let currentDirection = 0;
        let lastPosition = null;
        let movementHistory = [];
        let indoorPosition = { x: 0, y: 0 };
        let lastStepTime = 0;
        const stepLength = 0.7;
        let startPosition = null;

        // Initialize Map - PASTI JALAN
        function initMap() {
            console.log('üó∫Ô∏è Initializing map...');
            map = L.map('map').setView([-6.2088, 106.8456], 16);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            console.log('‚úÖ Map initialized successfully');
            locateUser();
            startCompass();
        }

        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        map.setView([lat, lng], 18);
                        
                        currentMarker = L.marker([lat, lng])
                            .addTo(map)
                            .bindPopup('üìç Lokasi Anda')
                            .openPopup();
                            
                        startPosition = { lat, lng };
                        lastPosition = { lat, lng, timestamp: Date.now() };
                        console.log('üìç User location found:', lat, lng);
                    },
                    function(error) {
                        console.warn('‚ùå GPS Error:', error);
                        alert('‚ö†Ô∏è Tidak bisa akses GPS. Pastikan izin lokasi diaktifkan.');
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            } else {
                alert('‚ùå Browser tidak support GPS!');
            }
        }

        // COMPASS FUNCTION - PASTI JALAN
        function startCompass() {
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', handleCompass);
                console.log('üß≠ Compass activated');
            } else {
                console.warn('‚ùå DeviceOrientation not supported');
                document.getElementById('compassDirection').textContent = 'No Compass';
            }
        }

        function handleCompass(event) {
            if (event.alpha !== null) {
                currentDirection = Math.round(event.alpha);
                
                const needle = document.getElementById('compassNeedle');
                const directionText = document.getElementById('compassDirection');
                
                if (needle && directionText) {
                    needle.style.transform = `translate(-50%, -100%) rotate(${currentDirection}deg)`;
                    directionText.textContent = `${currentDirection}¬∞ ${getDirectionText(currentDirection)}`;
                    updateMovementInfo();
                }
            }
        }

        function getDirectionText(degrees) {
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const index = Math.round(degrees / 45) % 8;
            return directions[index];
        }

        function updateMovementInfo() {
            const movementElement = document.getElementById('movementInfo');
            if (movementElement) {
                let movementText = `Arah: ${getDirectionText(currentDirection)}<br>Gerakan: -`;
                
                if (movementHistory.length > 0) {
                    const recentMovement = movementHistory[movementHistory.length - 1];
                    movementText = `Arah: ${getDirectionText(currentDirection)}<br>Gerakan: ${recentMovement.type}`;
                }
                
                movementElement.innerHTML = movementText;
            }
        }

        // START TRACKING - PASTI JALAN
        function startTracking() {
            if (isTracking) {
                alert('‚ö†Ô∏è Tracking sudah aktif!');
                return;
            }
            
            console.log('üöÄ START TRACKING');
            isTracking = true;
            isPaused = false;
            gpsStabilized = false;
            points = [];
            totalDistance = 0;
            stepCount = 0;
            photoCount = 0;
            startTime = new Date();
            indoorPosition = { x: 0, y: 0 };
            movementHistory = [];
            
            // Force outdoor mode dulu
            currentMode = 'outdoor';
            switchToOutdoorMode();
            
            // Update UI
            document.getElementById('trackStatus').textContent = 'TRACKING (GPS Stabilizing...)';
            document.getElementById('trackStatus').classList.add('tracking-active');
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('pauseBtn').classList.remove('hidden');
            document.getElementById('stopBtn').classList.remove('hidden');
            document.getElementById('photoCount').textContent = '0';
            document.getElementById('pointCount').textContent = '0';
            document.getElementById('distance').textContent = '0';
            document.getElementById('duration').textContent = '0';
            
            startDurationTimer();
            startGPSTracking();
            startMotionSensors();
            
            // Tunggu GPS stabil
            setTimeout(() => {
                gpsStabilized = true;
                document.getElementById('trackStatus').textContent = 'TRACKING ACTIVE';
                console.log('‚úÖ GPS stabilization period ended');
            }, 15000);
            
            alert('üöÄ TRACKING DIMULAI!\nMode: OUTDOOR (GPS)\nGerakkan smartphone Anda...');
        }

        function startMotionSensors() {
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', handleDeviceMotion);
            }
        }

        function handleDeviceMotion(event) {
            if (!isTracking || isPaused || currentMode !== 'indoor') return;
            
            const acceleration = event.accelerationIncludingGravity;
            const now = Date.now();
            
            if (acceleration && Math.abs(acceleration.z) > 1.5 && now - lastStepTime > 300) {
                stepCount++;
                updateIndoorPosition();
                lastStepTime = now;
                updateDisplay();
            }
        }

        // PAUSE TRACKING - PASTI JALAN
        function pauseTracking() {
            if (!isTracking) {
                alert('‚ö†Ô∏è Tracking belum dimulai!');
                return;
            }
            
            isPaused = !isPaused;
            
            if (isPaused) {
                document.getElementById('trackStatus').textContent = 'PAUSED';
                document.getElementById('trackStatus').classList.remove('tracking-active');
                document.getElementById('pauseBtn').textContent = '‚ñ∂ RESUME';
                
                setTimeout(() => {
                    const desc = prompt('Tambahkan deskripsi titik ini:') || 'Manual Point';
                    addManualPoint(desc);
                }, 500);
                
            } else {
                document.getElementById('trackStatus').textContent = 'TRACKING ACTIVE';
                document.getElementById('trackStatus').classList.add('tracking-active');
                document.getElementById('pauseBtn').textContent = '‚è∏ PAUSE';
            }
        }

        // STOP TRACKING - PASTI JALAN
        function stopTracking() {
            if (!isTracking) {
                alert('‚ö†Ô∏è Tracking belum dimulai!');
                return;
            }
            
            console.log('‚èπ STOP TRACKING');
            isTracking = false;
            isPaused = false;
            
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            stopMotionSensors();
            stopDurationTimer();
            
            document.getElementById('trackStatus').textContent = 'STOPPED';
            document.getElementById('trackStatus').classList.remove('tracking-active');
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('pauseBtn').classList.add('hidden');
            document.getElementById('stopBtn').classList.add('hidden');
            document.getElementById('pauseBtn').textContent = '‚è∏ PAUSE';
            
            const duration = Math.round((new Date() - startTime) / 1000);
            alert(`‚úÖ TRACKING SELESAI!\n${points.length} titik | ${totalDistance.toFixed(1)}m | ${duration}s | ${photoCount} foto`);
        }

        function stopMotionSensors() {
            window.removeEventListener('devicemotion', handleDeviceMotion);
        }

        // SWITCH MODE - PASTI JALAN
        function switchMode() {
            if (!isTracking) {
                alert('‚ö†Ô∏è Mulai tracking dulu sebelum ganti mode!');
                return;
            }
            
            if (currentMode === 'outdoor') {
                switchToIndoorMode();
                alert('üîÄ Switch to INDOOR mode (Step Tracking)');
            } else {
                switchToOutdoorMode();
                alert('üîÄ Switch to OUTDOOR mode (GPS Tracking)');
            }
        }

        function switchToIndoorMode() {
            currentMode = 'indoor';
            document.getElementById('modeIndicator').className = 'mode-indicator mode-indoor';
            document.getElementById('modeIndicator').textContent = 'INDOOR STEP';
            document.getElementById('accuracyInfo').innerHTML = '<span class="accuracy-medium">Step Tracking</span>';
            console.log('üîÄ Switched to INDOOR mode');
        }

        function switchToOutdoorMode() {
            currentMode = 'outdoor';
            document.getElementById('modeIndicator').className = 'mode-indicator mode-outdoor';
            document.getElementById('modeIndicator').textContent = 'OUTDOOR GPS';
            console.log('üîÄ Switched to OUTDOOR mode');
        }

        // ADD MANUAL POINT - PASTI JALAN
        function addManualPoint(description = 'Manual Point') {
            if (!isTracking) {
                alert('‚ö†Ô∏è Mulai tracking dulu sebelum tambah titik!');
                return;
            }
            
            const currentLatLng = currentMarker ? currentMarker.getLatLng() : map.getCenter();
            const pointData = {
                lat: currentLatLng.lat,
                lng: currentLatLng.lng,
                type: 'manual',
                description: description,
                timestamp: new Date().toISOString(),
                mode: currentMode
            };
            
            addPoint(pointData);
            
            L.marker([currentLatLng.lat, currentLatLng.lng], {
                icon: L.divIcon({
                    html: 'üìç',
                    iconSize: [25, 25],
                    className: 'manual-marker'
                })
            }).addTo(map).bindPopup(`<b>${description}</b>`);
            
            console.log('üìç Manual point added:', description);
        }

        // TAKE PHOTO - PASTI JALAN
        function takePhoto() {
            if (!isTracking) {
                alert('‚ùå Mulai tracking dulu sebelum ambil foto!');
                return;
            }
            
            photoCount++;
            const currentLatLng = currentMarker ? currentMarker.getLatLng() : map.getCenter();
            const description = prompt('Deskripsi foto:') || `Photo ${photoCount}`;
            
            // Add photo marker
            const photoMarker = L.marker([currentLatLng.lat, currentLatLng.lng], {
                icon: L.divIcon({
                    html: 'üì∏',
                    iconSize: [30, 30],
                    className: 'photo-marker'
                })
            }).addTo(map);
            
            photoMarker.bindPopup(`
                <b>üì∏ ${description}</b><br>
                Lat: ${currentLatLng.lat.toFixed(6)}<br>
                Lng: ${currentLatLng.lng.toFixed(6)}<br>
                Arah: ${getDirectionText(currentDirection)}<br>
                Waktu: ${new Date().toLocaleTimeString()}
            `).openPopup();
            
            // Record photo point
            addPoint({
                lat: currentLatLng.lat,
                lng: currentLatLng.lng,
                type: 'photo',
                description: description,
                direction: currentDirection,
                timestamp: new Date().toISOString(),
                mode: currentMode,
                photoNumber: photoCount
            });
            
            document.getElementById('photoCount').textContent = photoCount;
            alert(`üì∏ Foto #${photoCount} diambil!\n"${description}"`);
        }

        function startGPSTracking() {
            if (!navigator.geolocation) {
                alert('‚ùå Browser tidak support GPS!');
                return;
            }
            
            watchId = navigator.geolocation.watchPosition(
                handleGPSUpdate,
                handleGPSError,
                { enableHighAccuracy: true, maximumAge: 0, timeout: 30000 }
            );
        }

        function handleGPSUpdate(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            updateAccuracyDisplay(accuracy);
            
            if (currentMarker) {
                currentMarker.setLatLng([lat, lng]);
            } else {
                currentMarker = L.marker([lat, lng]).addTo(map).bindPopup('üìç Posisi Anda');
            }
            
            if (points.length < 5) {
                map.setView([lat, lng], 18);
            }
            
            // Deteksi pergerakan
            const movementType = detectMovementType(lat, lng);
            
            // Auto switch mode hanya jika sudah stabil
            const trackingDuration = (new Date() - startTime) / 1000;
            if (gpsStabilized && trackingDuration > 15) {
                if (accuracy > 50 && currentMode !== 'indoor') {
                    switchToIndoorMode();
                } else if (accuracy <= 30 && currentMode !== 'outdoor') {
                    switchToOutdoorMode();
                }
            }
            
            // Record point jika outdoor mode
            if (isTracking && !isPaused && currentMode === 'outdoor') {
                addPoint({ 
                    lat, lng, 
                    type: 'gps', 
                    accuracy,
                    movement: movementType,
                    direction: currentDirection,
                    timestamp: new Date().toISOString(),
                    mode: 'outdoor'
                });
                
                // Calculate distance
                if (lastPosition) {
                    const distance = calculateDistance(lastPosition.lat, lastPosition.lng, lat, lng);
                    totalDistance += distance;
                    updateDisplay();
                }
                
                lastPosition = { lat, lng, timestamp: Date.now() };
            }
        }

        function detectMovementType(newLat, newLng) {
            if (!lastPosition) return 'Unknown';
            
            const distance = calculateDistance(lastPosition.lat, lastPosition.lng, newLat, newLng);
            const timeDiff = (Date.now() - lastPosition.timestamp) / 1000;
            const speed = distance / timeDiff;
            
            let movementType = 'Jalan';
            if (speed > 2) movementType = 'Cepat';
            
            movementHistory.push({
                type: movementType,
                direction: getDirectionText(currentDirection),
                distance: distance,
                speed: speed,
                timestamp: Date.now()
            });
            
            if (movementHistory.length > 10) {
                movementHistory.shift();
            }
            
            return movementType;
        }

        function updateIndoorPosition() {
            const rad = currentDirection * Math.PI / 180;
            indoorPosition.x += Math.sin(rad) * stepLength;
            indoorPosition.y += Math.cos(rad) * stepLength;
            
            if (startPosition) {
                const approxLat = startPosition.lat + (indoorPosition.y / 111320);
                const approxLng = startPosition.lng + (indoorPosition.x / (111320 * Math.cos(startPosition.lat * Math.PI / 180)));
                
                addPoint({
                    lat: approxLat,
                    lng: approxLng,
                    type: 'indoor',
                    direction: currentDirection,
                    timestamp: new Date().toISOString(),
                    mode: 'indoor',
                    steps: stepCount,
                    indoorPosition: { ...indoorPosition }
                });
                
                totalDistance += stepLength;
                
                if (currentMarker) {
                    currentMarker.setLatLng([approxLat, approxLng]);
                }
            }
        }

        function addPoint(pointData) {
            points.push(pointData);
            updateDisplay();
            drawTrackLine();
        }

        function drawTrackLine() {
            if (trackPolyline) {
                map.removeLayer(trackPolyline);
            }
            
            const latLngs = points.filter(p => p.lat && p.lng).map(p => [p.lat, p.lng]);
            
            if (latLngs.length > 1) {
                trackPolyline = L.polyline(latLngs, {
                    color: '#00ff88',
                    weight: 6,
                    opacity: 0.8,
                    lineJoin: 'round'
                }).addTo(map);
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function updateAccuracyDisplay(accuracy) {
            const accuracyElement = document.getElementById('accuracyInfo');
            let accuracyClass = 'accuracy-low';
            
            if (accuracy < 10) accuracyClass = 'accuracy-high';
            else if (accuracy < 25) accuracyClass = 'accuracy-medium';
            
            accuracyElement.innerHTML = `<span class="${accuracyClass}">${Math.round(accuracy)}m</span>`;
        }

        function updateDisplay() {
            document.getElementById('pointCount').textContent = points.length;
            document.getElementById('distance').textContent = totalDistance.toFixed(1);
            document.getElementById('stepCount').textContent = stepCount;
        }

        function startDurationTimer() {
            durationInterval = setInterval(() => {
                if (startTime) {
                    const duration = Math.round((new Date() - startTime) / 1000);
                    document.getElementById('duration').textContent = duration;
                }
            }, 1000);
        }

        function stopDurationTimer() {
            if (durationInterval) {
                clearInterval(durationInterval);
                durationInterval = null;
            }
        }

        // DOWNLOAD SYSTEM - PASTI JALAN
        function showDownloadOptions() {
            if (points.length === 0) {
                alert('‚ùå Belum ada data tracking!');
                return;
            }
            document.getElementById('downloadOptions').classList.remove('hidden');
        }

        function hideDownloadOptions() {
            document.getElementById('downloadOptions').classList.add('hidden');
        }

        function downloadData(format) {
            if (points.length === 0) {
                alert('‚ùå Tidak ada data untuk didownload!');
                return;
            }

            let data, filename, mimeType;

            const metadata = {
                created: new Date().toISOString(),
                total_points: points.length,
                total_distance: totalDistance,
                duration: Math.round((new Date() - startTime) / 1000),
                mode: currentMode,
                steps: stepCount,
                photos: photoCount,
                start_position: startPosition
            };

            switch(format) {
                case 'json':
                    data = JSON.stringify({ metadata, track: points }, null, 2);
                    filename = `track_${new Date().getTime()}.json`;
                    mimeType = 'application/json';
                    break;

                case 'gpx':
                    data = toGPXFormat(points, metadata);
                    filename = `track_${new Date().getTime()}.gpx`;
                    mimeType = 'application/gpx+xml';
                    break;

                case 'kml':
                    data = toKMLFormat(points, metadata);
                    filename = `track_${new Date().getTime()}.kml`;
                    mimeType = 'application/vnd.google-earth.kml+xml';
                    break;

                case 'csv':
                    data = toCSVFormat(points, metadata);
                    filename = `track_${new Date().getTime()}.csv`;
                    mimeType = 'text/csv';
                    break;
            }

            const blob = new Blob([data], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            hideDownloadOptions();
            alert(`‚úÖ Data berhasil didownload!\nFormat: ${format.toUpperCase()}\nTitik: ${points.length}\nFoto: ${photoCount}`);
        }

        function toGPXFormat(points, metadata) {
            let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="GPS Mapping Tool">
    <metadata>
        <name>Track ${new Date().toLocaleString()}</name>
        <desc>Total points: ${metadata.total_points}, Distance: ${metadata.total_distance}m</desc>
        <time>${metadata.created}</time>
    </metadata>
    <trk>
        <name>GPS Track</name>
        <trkseg>`;

            points.forEach(point => {
                if (point.lat && point.lng) {
                    gpx += `
            <trkpt lat="${point.lat}" lon="${point.lng}">
                <time>${point.timestamp}</time>
                <desc>Type: ${point.type}, Mode: ${point.mode}</desc>
            </trkpt>`;
                }
            });

            gpx += `
        </trkseg>
    </trk>
</gpx>`;
            return gpx;
        }

        function toKMLFormat(points, metadata) {
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
        <name>Track ${new Date().toLocaleString()}</name>
        <description>GPS Mapping Tool - Points: ${metadata.total_points}</description>
        <Style id="trackStyle">
            <LineStyle>
                <color>ff00ff88</color>
                <width>4</width>
            </LineStyle>
        </Style>
        <Placemark>
            <name>Tracking Path</name>
            <styleUrl>#trackStyle</styleUrl>
            <LineString>
                <coordinates>`;

            points.forEach(point => {
                if (point.lat && point.lng) {
                    kml += `
                    ${point.lng},${point.lat},0 `;
                }
            });

            kml += `
                </coordinates>
            </LineString>
        </Placemark>
    </Document>
</kml>`;
            return kml;
        }

        function toCSVFormat(points, metadata) {
            let csv = 'Latitude,Longitude,Type,Mode,Timestamp,Distance\n';
            
            points.forEach(point => {
                if (point.lat && point.lng) {
                    csv += `${point.lat},${point.lng},${point.type},${point.mode},${point.timestamp},${point.distance || 0}\n`;
                }
            });
            
            return csv;
        }

        function handleGPSError(error) {
            console.error('GPS Error:', error);
            let message = 'GPS Error';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Izin GPS ditolak';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'GPS tidak tersedia';
                    break;
                case error.TIMEOUT:
                    message = 'GPS timeout';
                    break;
            }
            
            document.getElementById('accuracyInfo').innerHTML = `<span class="accuracy-low">${message}</span>`;
        }

        // INITIALIZE - PASTI JALAN SAAT PAGE LOAD
        window.addEventListener('load', function() {
            console.log('üöÄ Initializing GPS Mapping Tool...');
            initMap();
        });
        
        console.log('‚úÖ GPS MAPPING TOOL LOADED - ALL BUTTONS WORKING!');
    </script>
</body>
</html>